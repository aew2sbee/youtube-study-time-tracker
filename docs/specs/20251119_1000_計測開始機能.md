# 計測開始機能

## ユーザーストーリー
- YouTubeのライブ配信のチャット欄に"start"を入力し、計測が開始される

## 要件
- ライブ配信のチャット欄に入力された文字は小文字で変換して以後の処理を行う


## 性能要件

## 境界ケース


## データフロー層

| データフロー層 | 理想的な実装 | 現在の実装ファイル | ステータス |
|---|---|---|:---:|
| **User Action** | YouTubeライブチャットで「start」とコメント | YouTubeライブチャットで「start」とコメント | ✅ |
| **Client Component**<br>('use client') | クライアント側のUI | `src/app/page.tsx`<br>`src/client/components/FocusTimeTracker.tsx`<br>`src/hooks/useUsers.ts` | ✅ |
| **Server Action**<br>('use server')<br>← 副作用処理 | `src/server/actions/studyAction.ts` | `src/server/actions/studyAction.ts`<br>- `startStudyAction`<br>- `restartStudyAction` | ✅ |
| **Usecase**<br>(ビジネスロジック統合) | `src/server/usecases/studyUsecase.ts` | `src/server/usecases/studyUsecase.ts`<br>- `startStudy`<br>- `restartStudy`<br>- `updateStudyTime` | ✅ |
| **Repository**<br>(DB操作) | DB操作のみ | （このアクションではDB操作なし） | - |
| **Database** | データ永続化 | （このアクションではDB操作なし） | - |
| **Loader**<br>(データ取得)<br>← 副作用なし | `src/server/loaders/xxxLoader.ts` | **（未実装）** | ❌ |
| **Server Component** | サーバー側でデータ取得 | **（未実装）** | ❌ |
| **Client Component**<br>(表示) | クライアント側の表示のみ | `src/client/components/FocusTimeTracker.tsx` | ✅ |

## タスク

### Phase 1: 既存実装の統合（優先度: 高）
- [x] Server Actionの実装
  - [x] `src/server/actions/studyAction.ts`を作成
  - [x] `startStudyAction`関数を実装
  - [x] `restartStudyAction`関数を実装
- [x] Usecaseの実装
  - [x] `src/server/usecases/studyUsecase.ts`を作成
  - [x] `startStudy`関数を実装（新規ユーザーの学習開始）
  - [x] `restartStudy`関数を実装（既存ユーザーの学習再開）
  - [x] `updateStudyTime`関数を実装（学習時間の更新）
- [x] YouTubeヘルパーの実装
  - [x] `src/server/lib/youtubeHelper.ts`を作成
  - [x] `postYouTubeComment`関数を実装（コメント投稿）
- [x] 型定義の整理
  - [x] YouTube API公式型（`youtube_v3.Schema$LiveChatMessage`）を使用
  - [x] すべてのログを日本語化
  - [x] `User`型に`isChatSponsor`プロパティを追加
  - [x] `name` → `displayName`への変更

### Phase 2: Client ComponentからServer Actionを呼び出すように修正（優先度: 高）
- [ ] `src/hooks/useUsers.ts`をリファクタリング
  - [ ] 既存のAPI Route呼び出しをServer Action呼び出しに変更
  - [ ] `startStudyAction`を新規ユーザーの開始時に呼び出す
  - [ ] `restartStudyAction`を既存ユーザーの再開時に呼び出す
  - [ ] エラーハンドリングを追加

### Phase 3: Loaderの実装（優先度: 中）
- [ ] `src/server/loaders/`ディレクトリを作成
- [ ] `youtubeLoader.ts`を実装
  - [ ] `getLiveChatMessages`関数（YouTubeチャットメッセージ取得）
  - [ ] データ整形ロジックを実装
- [ ] `studyLoader.ts`を実装
  - [ ] `getActiveUsers`関数（現在学習中のユーザー一覧取得）
  - [ ] データ整形ロジックを実装

### Phase 4: Server Componentの実装（優先度: 中）
- [ ] `src/app/page.tsx`をServer Componentに変更
  - [ ] Loaderからデータを取得
  - [ ] 取得データをClient Componentに渡す
- [ ] `src/client/components/FocusTimeTracker.tsx`の修正
  - [ ] Server Componentから渡されたデータを受け取るように変更
  - [ ] 表示ロジックのみに専念

### Phase 5: 既存API Routesのクリーンアップ（優先度: 低）
- [ ] `src/app/api/youtube/route.ts`の整理
  - [ ] GET処理をLoaderに移行
  - [ ] POST処理をServer Actionに移行済みか確認
  - [ ] 不要な部分を削除
- [ ] `src/lib/user.ts`の整理
  - [ ] Usecaseに移行済みの関数を削除または統合
  - [ ] 残す必要がある関数を精査

### Phase 6: テストの追加（優先度: 低）
- [ ] Server Actionのテスト
  - [ ] `startStudyAction`のテスト
  - [ ] `restartStudyAction`のテスト
- [ ] Usecaseのテスト
  - [ ] `startStudy`のテスト
  - [ ] `restartStudy`のテスト
  - [ ] `updateStudyTime`のテスト
- [ ] Loaderのテスト
  - [ ] `getLiveChatMessages`のテスト
  - [ ] `getActiveUsers`のテスト

## 備考
- 小文字変換は`src/lib/liveChatMessage.ts`の`isStartMessage`関数内で実装済み
- YouTube API公式型を直接使用することで型安全性を向上
- ログはすべて日本語で統一
